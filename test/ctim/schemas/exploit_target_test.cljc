(ns ctim.schemas.exploit-target-test
  (:require #?(:clj  [clojure.test :refer [deftest is testing use-fixtures]]
               :cljs [cljs.test :refer-macros [deftest is testing use-fixtures]])
            [ctim.schemas.exploit-target :as et]
            [ctim.schemas.common :as c]
            [flanders.schema :as fs]
            [schema.core :as s]))

(use-fixtures :once (fn [t]
                      (s/with-fn-validation (t))))

(deftest test-exploit-target-schema
  (testing "example with all possible fields"
    (is (s/validate
         (fs/->schema et/ExploitTarget)
         {:id "exploit-target-123"
          :type "exploit-target"
          :external_ids ["http://ex.tld/ctia/exploit-target/exploit-target-123"
                         "http://ex.tld/ctia/exploit-target/exploit-target-345"]
          :revision 1
          :timestamp #inst "2016-02-11T00:40:48.212-00:00"
          :language "language"
          :source "source"
          :source_uri "http://example.com"
          :title "exploit-target"
          :description "description"
          :short_description "short description"
          :tlp "green"
          :schema_version c/ctim-schema-version
          :vulnerability [{:title "vulnerability"
                           :description "description"
                           :is_known true
                           :is_public_acknowledged false
                           :short_description "short description"
                           :cve_id "cve_id"
                           :osvdb_id 1
                           :source "source"
                           :discovered_datetime #inst "2016-02-11T00:40:48.212-00:00"
                           :published_datetime #inst "2016-02-11T00:40:48.212-00:00"
                           :affected_software ["affected sw"]
                           :references ["http://example.com"]}]
          :weakness [{:description "description"
                      :cwe_id "cwe_id"}]
          :configuration [{:description "description"
                           :short_description "short desc"
                           :cce_id "cce_id"}]
          :potential_COAs [{:COA_id "coa-777"
                            :confidence "Low"
                            :source "source"
                            :relationship "rel"}
                           {:COA_id "coa-333"
                            :confidence "Low"
                            :source "source"
                            :relationship "rel"}]
          :related_exploit_targets [{:confidence "High"
                                     :source "source"
                                     :relationship "relationship"
                                     :exploit_target_id "exploit-target-123"}]
          :valid_time {:start_time #inst "2016-02-11T00:40:48.212-00:00"
                       :end_time #inst "2525-01-01T00:00:00.000-00:00"}})))

  (testing "example with only required fields"
    (is (s/validate
         (fs/->schema et/ExploitTarget)
         {:id "exploit-target-123"
          :type "exploit-target"
          :schema_version c/ctim-schema-version
          :valid_time {}}))))

(deftest test-new-exploit-target-schema
  (testing "example with all possible fields"
    (is (s/validate
         (fs/->schema et/NewExploitTarget)
         {:id "exploit-target-123"
          :type "exploit-target"
          :external_ids ["http://ex.tld/ctia/exploit-target/exploit-target-123"
                         "http://ex.tld/ctia/exploit-target/exploit-target-345"]
          :revision 1
          :timestamp #inst "2016-02-11T00:40:48.212-00:00"
          :language "language"
          :source "source"
          :source_uri "http://example.com"
          :title "exploit-target"
          :description "description"
          :short_description "short description"
          :tlp "green"
          :schema_version c/ctim-schema-version
          :vulnerability [{:title "vulnerability"
                           :description "description"
                           :is_known true
                           :is_public_acknowledged false
                           :short_description "short description"
                           :cve_id "cve_id"
                           :osvdb_id 1
                           :source "source"
                           :discovered_datetime #inst "2016-02-11T00:40:48.212-00:00"
                           :published_datetime #inst "2016-02-11T00:40:48.212-00:00"
                           :affected_software ["affected sw"]
                           :references ["http://example.com"]}]
          :weakness [{:description "description"
                      :cwe_id "cwe_id"}]
          :configuration [{:description "description"
                           :short_description "short desc"
                           :cce_id "cce_id"}]
          :potential_COAs [{:COA_id "coa-777"
                            :confidence "Low"
                            :source "source"
                            :relationship "rel"}
                           {:COA_id "coa-333"
                            :confidence "Low"
                            :source "source"
                            :relationship "rel"}]
          :related_exploit_targets [{:confidence "High"
                                     :source "source"
                                     :relationship "relationship"
                                     :exploit_target_id "exploit-target-123"}]
          :valid_time {:start_time #inst "2016-02-11T00:40:48.212-00:00"
                       :end_time #inst "2525-01-01T00:00:00.000-00:00"}})))

  (testing "example with only required fields"
    (is (s/validate
         (fs/->schema et/NewExploitTarget)
         {}))))

(deftest test-stored-exploit-target-schema
  (testing "example with all possible fields"
    (is (s/validate
         (fs/->schema et/StoredExploitTarget)
         {:id "exploit-target-123"
          :type "exploit-target"
          :external_ids ["http://ex.tld/ctia/exploit-target/exploit-target-123"
                         "http://ex.tld/ctia/exploit-target/exploit-target-345"]
          :revision 1
          :timestamp #inst "2016-02-11T00:40:48.212-00:00"
          :language "language"
          :source "source"
          :source_uri "http://example.com"
          :title "exploit-target"
          :description "description"
          :short_description "short description"
          :tlp "green"
          :schema_version c/ctim-schema-version
          :vulnerability [{:title "vulnerability"
                           :description "description"
                           :is_known true
                           :is_public_acknowledged false
                           :short_description "short description"
                           :cve_id "cve_id"
                           :osvdb_id 1
                           :source "source"
                           :discovered_datetime #inst "2016-02-11T00:40:48.212-00:00"
                           :published_datetime #inst "2016-02-11T00:40:48.212-00:00"
                           :affected_software ["affected sw"]
                           :references ["http://example.com"]}]
          :weakness [{:description "description"
                      :cwe_id "cwe_id"}]
          :configuration [{:description "description"
                           :short_description "short desc"
                           :cce_id "cce_id"}]
          :potential_COAs [{:COA_id "coa-777"
                            :confidence "Low"
                            :source "source"
                            :relationship "rel"}
                           {:COA_id "coa-333"
                            :confidence "Low"
                            :source "source"
                            :relationship "rel"}]
          :related_exploit_targets [{:confidence "High"
                                     :source "source"
                                     :relationship "relationship"
                                     :exploit_target_id "exploit-target-123"}]
          :valid_time {:start_time #inst "2016-02-11T00:40:48.212-00:00"
                       :end_time #inst "2525-01-01T00:00:00.000-00:00"}
          :owner "foouser"
          :created #inst "2016-02-11T00:40:48.212-00:00"
          :modified #inst "2016-02-11T00:40:48.212-00:00"})))

  (testing "example with only required fields"
    (is (s/validate
         (fs/->schema et/StoredExploitTarget)
         {:id "exploit-target-123"
          :type "exploit-target"
          :schema_version c/ctim-schema-version
          :valid_time {}
          :owner "foouser"
          :created #inst "2016-02-11T00:40:48.212-00:00"
          :modified #inst "2016-02-11T00:40:48.212-00:00"}))))
